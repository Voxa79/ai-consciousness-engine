# Supervisor configuration for Consciousness Platform
# Manages multiple processes: nginx, api-gateway, consciousness-engine

[supervisord]
nodaemon=true
user=consciousness
logfile=/app/logs/supervisord.log
pidfile=/app/logs/supervisord.pid
childlogdir=/app/logs/

[unix_http_server]
file=/app/logs/supervisor.sock
chmod=0700
chown=consciousness:consciousness

[supervisorctl]
serverurl=unix:///app/logs/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Nginx web server
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
user=root
autostart=true
autorestart=true
startretries=3
stdout_logfile=/app/logs/nginx_stdout.log
stderr_logfile=/app/logs/nginx_stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5

# API Gateway
[program:api-gateway]
command=/app/bin/api-gateway
user=consciousness
directory=/app
autostart=true
autorestart=true
startretries=3
stdout_logfile=/app/logs/api_gateway_stdout.log
stderr_logfile=/app/logs/api_gateway_stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5
environment=RUST_LOG=info,PORT=8080,CONSCIOUSNESS_ENGINE_URL=http://127.0.0.1:8081

# Consciousness Engine
[program:consciousness-engine]
command=/app/bin/consciousness-engine
user=consciousness
directory=/app
autostart=true
autorestart=true
startretries=3
stdout_logfile=/app/logs/consciousness_engine_stdout.log
stderr_logfile=/app/logs/consciousness_engine_stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5
environment=RUST_LOG=info,PORT=8081,CONSCIOUSNESS_CONFIG_PATH=/app/config

# Process monitoring and alerting
[program:health-monitor]
command=/app/bin/health-check.sh --monitor
user=consciousness
directory=/app
autostart=true
autorestart=true
startretries=3
stdout_logfile=/app/logs/health_monitor_stdout.log
stderr_logfile=/app/logs/health_monitor_stderr.log

# Log rotation (optional)
[program:logrotate]
command=/usr/sbin/logrotate -f /app/config/logrotate.conf
user=consciousness
autostart=false
autorestart=false
startsecs=0

# Event listeners for process monitoring
[eventlistener:crashmail]
command=/app/bin/crashmail.py
events=PROCESS_STATE_EXITED
user=consciousness
autostart=true
autorestart=true

# Group configuration for easier management
[group:consciousness-platform]
programs=nginx,api-gateway,consciousness-engine
priority=999