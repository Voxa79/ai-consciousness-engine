apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: vault
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/instance: vault
    app.kubernetes.io/component: security
    app.kubernetes.io/version: "1.15.2"
spec:
  serviceName: vault-internal
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
      app.kubernetes.io/instance: vault
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vault
        app.kubernetes.io/instance: vault
        app.kubernetes.io/component: security
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8200"
        prometheus.io/path: "/v1/sys/metrics"
        prometheus.io/scheme: "https"
    spec:
      serviceAccountName: vault
      securityContext:
        runAsNonRoot: true
        runAsUser: 100
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: vault
                app.kubernetes.io/instance: vault
            topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: 30
      containers:
      - name: vault
        image: hashicorp/vault:1.15.2
        imagePullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
            add:
            - IPC_LOCK
        command:
        - "/bin/sh"
        - "-ec"
        args:
        - |
          cp /vault/config/vault.hcl /tmp/vault.hcl
          sed -i "s/HOSTNAME/$(hostname)/g" /tmp/vault.hcl
          exec vault server -config=/tmp/vault.hcl
        env:
        - name: HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: VAULT_ADDR
          value: "https://127.0.0.1:8200"
        - name: VAULT_API_ADDR
          value: "https://$(HOSTNAME).vault-internal.vault.svc.cluster.local:8200"
        - name: VAULT_CLUSTER_ADDR
          value: "https://$(HOSTNAME).vault-internal.vault.svc.cluster.local:8201"
        - name: VAULT_LOG_LEVEL
          value: "info"
        - name: VAULT_LOG_FORMAT
          value: "json"
        - name: VAULT_RAFT_NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: AWS_REGION
          value: "us-west-2"
        ports:
        - name: http
          containerPort: 8200
          protocol: TCP
        - name: https-internal
          containerPort: 8201
          protocol: TCP
        - name: http-rep
          containerPort: 8202
          protocol: TCP
        readinessProbe:
          exec:
            command:
            - "/bin/sh"
            - "-ec"
            - "vault status -tls-skip-verify"
          failureThreshold: 2
          initialDelaySeconds: 5
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 3
        livenessProbe:
          httpGet:
            path: "/v1/sys/health?standbyok=true"
            port: 8200
            scheme: HTTPS
          failureThreshold: 2
          initialDelaySeconds: 60
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 3
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: config
          mountPath: /vault/config
          readOnly: true
        - name: tls
          mountPath: /vault/tls
          readOnly: true
        - name: data
          mountPath: /vault/data
        - name: tmp
          mountPath: /tmp
        - name: home
          mountPath: /home/vault
      volumes:
      - name: config
        configMap:
          name: vault-config
      - name: tls
        secret:
          secretName: vault-tls
          defaultMode: 0400
      - name: tmp
        emptyDir: {}
      - name: home
        emptyDir: {}
  volumeClaimTemplates:
  - metadata:
      name: data
      labels:
        app.kubernetes.io/name: vault
        app.kubernetes.io/instance: vault
    spec:
      accessModes:
      - ReadWriteOnce
      storageClassName: gp3-encrypted
      resources:
        requests:
          storage: 10Gi